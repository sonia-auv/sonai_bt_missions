<?xml version="1.0" encoding="UTF-8"?>
<root BTCPP_format="4">
  <BehaviorTree ID="FindGate">
    <Fallback>
      <RetryUntilSuccessful num_attempts="5">
        <CheckAiInfo max_count="1"
                     ai_info="{gate_info}"
                     confidence="0.800000"
                     camera="0"
                     min_count="1"
                     classification="{classification}"/>
      </RetryUntilSuccessful>
      <SubTree ID="ForwardStrafeGateSearch"
               classification="{classification}"
               ai_info="{gate_info}"
               _autoremap="true"/>
    </Fallback>
  </BehaviorTree>

  <BehaviorTree ID="ForwardStrafeGateSearch">
    <RetryUntilSuccessful num_attempts="3">
      <Sequence>
        <Script code="gate_try_counter:=0"/>
        <RetryUntilSuccessful num_attempts="3">
          <Sequence>
            <Script code="gate_try_counter+=1"/>
            <SubTree ID="GateStrafeSearchPattern"
                     attempt_num="{gate_try_counter}"
                     _autoremap="true"/>
            <RetryUntilSuccessful num_attempts="3">
              <CheckAiInfo max_count="1"
                           ai_info="{ai_info}"
                           confidence="0.800000"
                           camera="0"
                           min_count="1"
                           classification="{classification}"/>
            </RetryUntilSuccessful>
          </Sequence>
        </RetryUntilSuccessful>
      </Sequence>
    </RetryUntilSuccessful>
  </BehaviorTree>

  <BehaviorTree ID="GateAlignAngle">
    <SubTree ID="AngleAlign"
             classification="gate_rouge"
             _autoremap="true"/>
  </BehaviorTree>

  <BehaviorTree ID="GateAlignTrans">
    <IfThenElse>
      <RetryUntilSuccessful num_attempts="3">
        <SubTree ID="FindGate"
                 classification="gate_rouge"
                 gate_info="{gate_info}"/>
      </RetryUntilSuccessful>
      <Sequence>
        <ExtractAiListItem aiObject="{gate_item}"
                           Index="0"
                           array="{gate_info}"/>
        <SubTree ID="TransAlignYZ"
                 detection_object="{gate_item}"
                 target_x="300"
                 target_y="150"
                 error_margin="0.05"
                 _autoremap="true"/>
      </Sequence>
      <AlwaysFailure/>
    </IfThenElse>
  </BehaviorTree>

  <BehaviorTree ID="GateStrafeSearchPattern">
    <Switch3 case_1="1"
             case_2="2"
             case_3="3"
             variable="{attempt_num}">
      <SubTree ID="MoveSinglePose"
               positionX="0.0"
               positionY="-0.5"
               positionZ="0.0"
               orientationX="0.0"
               orientationY="0.0"
               orientationZ="0.0"
               frame="1"
               _autoremap="true"/>
      <SubTree ID="MoveSinglePose"
               positionX="0.0"
               positionY="1"
               positionZ="0.0"
               orientationX="0.0"
               orientationY="0.0"
               orientationZ="0.0"
               frame="1"
               _autoremap="true"/>
      <Sequence>
        <SubTree ID="MoveSinglePose"
                 positionX="0.0"
                 positionY="-0.5"
                 positionZ="0.0"
                 orientationX="0.0"
                 orientationY="0.0"
                 orientationZ="0.0"
                 frame="1"
                 _autoremap="true"/>
        <SubTree ID="MoveSinglePose"
                 positionX="1"
                 positionY="0.0"
                 positionZ="0.0"
                 orientationX="0.0"
                 orientationY="0.0"
                 orientationZ="0"
                 frame="1"
                 _autoremap="true"/>
      </Sequence>
      <AlwaysFailure/>
    </Switch3>
  </BehaviorTree>

  <!-- Description of Node Models (used by Groot) -->
  <TreeNodesModel>
    <SubTree ID="AngleAlign"
             editable="true">
      <input_port name="classification"/>
    </SubTree>
    <Condition ID="CheckAiInfo">
      <input_port name="max_count"
                  default="1"
                  type="int"/>
      <output_port name="ai_info"
                   type="AiDetectionArray"/>
      <input_port name="confidence"
                  default="0.800000"
                  type="float"/>
      <input_port name="camera"
                  default="0"
                  type="int">0: Front, 1: Bottom</input_port>
      <input_port name="min_count"
                  default="1"
                  type="int"/>
      <input_port name="classification"
                  type="std::string"/>
    </Condition>
    <Action ID="ExtractAiListItem">
      <output_port name="aiObject"
                   type="AiDetection"/>
      <input_port name="Index"
                  type="int"/>
      <input_port name="array"
                  type="AiDetectionArray"/>
    </Action>
    <SubTree ID="FindGate"
             editable="true">
      <input_port name="classification"/>
      <output_port name="gate_info"/>
    </SubTree>
    <SubTree ID="ForwardStrafeGateSearch"
             editable="true">
      <input_port name="classification"/>
      <output_port name="ai_info"/>
    </SubTree>
    <SubTree ID="GateStrafeSearchPattern"
             editable="true">
      <input_port name="attempt_num"/>
    </SubTree>
    <SubTree ID="MoveSinglePose"
             editable="true">
      <input_port name="positionX"
                  default="0.0"/>
      <input_port name="positionY"
                  default="0.0"/>
      <input_port name="positionZ"
                  default="0.0"/>
      <input_port name="orientationX"
                  default="0.0"/>
      <input_port name="orientationY"
                  default="0.0"/>
      <input_port name="orientationZ"
                  default="0.0"/>
      <input_port name="frame"
                  default="1"/>
    </SubTree>
    <SubTree ID="TransAlignYZ"
             editable="true">
      <input_port name="detection_object"/>
      <input_port name="target_x"
                  default="300"/>
      <input_port name="target_y"
                  default="200"/>
      <input_port name="error_margin"
                  default="0.05"/>
    </SubTree>
  </TreeNodesModel>

</root>
