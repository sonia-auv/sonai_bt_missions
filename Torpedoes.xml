<?xml version="1.0" encoding="UTF-8"?>
<root BTCPP_format="4">
  <BehaviorTree ID="AlignPort">
    <IfThenElse>
      <RetryUntilSuccessful num_attempts="3">
        <CheckAiInfo max_count="1"
                     ai_info="{torp_target_arr}"
                     confidence="0.800000"
                     camera="0"
                     min_count="1"
                     classification="torpille_target"/>
      </RetryUntilSuccessful>
      <Sequence>
        <ExtractAiListItem aiObject="{torp_target}"
                           Index="0"
                           array="{torp_target_arr}"/>
        <InitTraj trajectory="{torp_traj_port}"/>
        <ForceSuccess>
          <CheckTranslationYZAlign error_margin="0.10000"
                                   target_y="275"
                                   target_x="225"
                                   traj="{torp_traj_port}"
                                   detection_object="{torp_target}"/>
        </ForceSuccess>
        <SendTrajToPlanner trajectory="{torp_traj_port}"
                           interpolation="0"/>
        <WaitTargetReached timeout="5"/>
      </Sequence>
      <AlwaysFailure/>
    </IfThenElse>
  </BehaviorTree>

  <BehaviorTree ID="AlignSize">
    <Sequence>
      <CheckAiInfo max_count="4"
                   ai_info="{torp_target_list}"
                   confidence="0.800000"
                   camera="0"
                   min_count="1"
                   classification="torpille_target"/>
      <GetTorpedoTarget selected_target="{torp_target}"
                        size="{size}"
                        torpedo_objs="{torp_target_list}"/>
      <SubTree ID="TransAlign"
               detection_object="{torp_target}"
               target_x="300"
               target_y="200"
               error_margin="0.10"
               _autoremap="true"/>
    </Sequence>
  </BehaviorTree>

  <BehaviorTree ID="AlignStar">
    <IfThenElse>
      <RetryUntilSuccessful num_attempts="3">
        <CheckAiInfo max_count="1"
                     ai_info="{torp_target_arr}"
                     confidence="0.800000"
                     camera="0"
                     min_count="1"
                     classification="torpille_target"/>
      </RetryUntilSuccessful>
      <Sequence>
        <ExtractAiListItem aiObject="{torp_target}"
                           Index="0"
                           array="{torp_target_arr}"/>
        <InitTraj trajectory="{torp_traj_star}"/>
        <ForceSuccess>
          <CheckTranslationYZAlign error_margin="0.10000"
                                   target_y="275"
                                   target_x="375"
                                   traj="{torp_traj_star}"
                                   detection_object="{torp_target}"/>
        </ForceSuccess>
        <SendTrajToPlanner trajectory="{torp_traj_star}"
                           interpolation="0"/>
        <WaitTargetReached timeout="5"/>
      </Sequence>
      <AlwaysFailure/>
    </IfThenElse>
  </BehaviorTree>

  <BehaviorTree ID="AlignTorpFrame">
    <IfThenElse>
      <RetryUntilSuccessful num_attempts="3">
        <CheckAiInfo max_count="1"
                     ai_info="{torp_frame_arr}"
                     confidence="0.800000"
                     camera="0"
                     min_count="1"
                     classification="torpille"/>
      </RetryUntilSuccessful>
      <Sequence>
        <ExtractAiListItem aiObject="{torp_frame}"
                           Index="0"
                           array="{torp_frame_arr}"/>
        <SubTree ID="TransAlign"
                 detection_object="{torp_frame}"
                 target_x="300"
                 target_y="200"
                 error_margin="0.1"
                 _autoremap="true"/>
      </Sequence>
      <AlwaysFailure/>
    </IfThenElse>
  </BehaviorTree>

  <BehaviorTree ID="AlignTorpFrameAngle">
    <SubTree ID="AngleAlign"
             classification="torpille"/>
  </BehaviorTree>

  <BehaviorTree ID="AlignTorpID">
    <Sequence>
      <SubTree ID="AlignSize"
               size="0"
               _autoremap="true"/>
      <Sequence>
        <InitTraj trajectory="{torp_traj}"/>
        <MoveToTarget trajectory="{torp_traj}"
                      offset="-0.5"
                      aiObj="{torp_target}"/>
        <SendTrajToPlanner trajectory="{torp_traj}"
                           interpolation="0"/>
        <WaitTargetReached timeout="5"/>
      </Sequence>
    </Sequence>
  </BehaviorTree>

  <!-- Description of Node Models (used by Groot) -->
  <TreeNodesModel>
    <SubTree ID="AlignSize"
             editable="true">
      <input_port name="size"
                  default="0"/>
    </SubTree>
    <SubTree ID="AngleAlign"
             editable="true">
      <input_port name="classification"/>
    </SubTree>
    <Condition ID="CheckAiInfo">
      <input_port name="max_count"
                  default="1"
                  type="int"/>
      <output_port name="ai_info"
                   type="AiDetectionArray"/>
      <input_port name="confidence"
                  default="0.800000"
                  type="float"/>
      <input_port name="camera"
                  default="0"
                  type="int">0: Front, 1: Bottom</input_port>
      <input_port name="min_count"
                  default="1"
                  type="int"/>
      <input_port name="classification"
                  type="std::string"/>
    </Condition>
    <Condition ID="CheckTranslationYZAlign">
      <input_port name="error_margin"
                  default="0.050000"
                  type="float">percentage of error off the target (0-1)</input_port>
      <input_port name="target_y"
                  type="int"/>
      <input_port name="target_x"
                  type="int"/>
      <inout_port name="traj"
                  type="Trajectory"/>
      <input_port name="detection_object"
                  type="AiDetection"/>
    </Condition>
    <Action ID="ExtractAiListItem">
      <output_port name="aiObject"
                   type="AiDetection"/>
      <input_port name="Index"
                  type="int"/>
      <input_port name="array"
                  type="AiDetectionArray"/>
    </Action>
    <Action ID="GetTorpedoTarget">
      <output_port name="selected_target"
                   type="AiDetection"/>
      <input_port name="size"
                  type="int">0: smallest, 3: biggest</input_port>
      <input_port name="torpedo_objs"
                  type="AiDetectionArray"/>
    </Action>
    <Action ID="InitTraj">
      <output_port name="trajectory"
                   type="Trajectory"/>
    </Action>
    <Action ID="MoveToTarget">
      <inout_port name="trajectory"
                  type="Trajectory"/>
      <input_port name="offset"
                  type="float"/>
      <input_port name="aiObj"
                  type="AiDetection"/>
    </Action>
    <Action ID="SendTrajToPlanner">
      <inout_port name="trajectory"
                  type="Trajectory"/>
      <input_port name="interpolation"
                  default="0"
                  type="int"/>
    </Action>
    <SubTree ID="TransAlign"
             editable="true">
      <input_port name="detection_object"/>
      <input_port name="target_x"
                  default="300"/>
      <input_port name="target_y"
                  default="200"/>
      <input_port name="error_margin"
                  default="0.05"/>
    </SubTree>
    <Action ID="WaitTargetReached">
      <input_port name="timeout"
                  default="5"
                  type="int"/>
    </Action>
  </TreeNodesModel>

</root>
